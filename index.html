<!DOCTYPE html>
<html>
<head>
  <title>FCM Test - Working Solution</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js"></script>
</head>
<body>
  <h2>FCM Test - Final Solution</h2>
  <button onclick="testFCM()">Get FCM Token</button>
  <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; font-family: monospace; white-space: pre-wrap;"></div>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBNpWwlJV-2ay7_D8_AXfM2k_WpImVIEYs",
      authDomain: "gpms-notifications.firebaseapp.com",
      projectId: "gpms-notifications",
      storageBucket: "gpms-notifications.firebasestorage.app",
      messagingSenderId: "240580625031",
      appId: "1:240580625031:web:52421c30f5f542dfd0ae22",
      measurementId: "G-D41F7DQVLP"
    };
    
    // Initialize Firebase
    let messaging = null;
    
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase initialized');
        messaging = firebase.messaging();
      } else {
        messaging = firebase.messaging();
      }
    } catch (err) {
      console.error('Firebase init error:', err);
    }
    
    async function testFCM() {
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = 'Starting FCM setup...\n';
      
      try {
        // Step 1: Register service worker
        resultDiv.textContent += '1. Registering service worker...\n';
        const registration = await navigator.serviceWorker.register(
          '/gpms/firebase-messaging-sw.js',
          { scope: '/gpms/' }
        );
        
        console.log('Service worker registered:', registration);
        resultDiv.textContent += '✓ Service worker registered\n';
        
        // Step 2: Request permission
        resultDiv.textContent += '2. Requesting notification permission...\n';
        const permission = await Notification.requestPermission();
        resultDiv.textContent += `✓ Permission: ${permission}\n`;
        
        if (permission !== 'granted') {
          resultDiv.textContent += '✗ Permission denied\n';
          return;
        }
        
        // Step 3: Get FCM token
        resultDiv.textContent += '3. Getting FCM token...\n';
        
        const vapidKey = 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq';
        
        // IMPORTANT: Use the serviceWorkerRegistration option
        const token = await messaging.getToken({
          vapidKey: vapidKey,
          serviceWorkerRegistration: registration
        });
        
        if (token) {
          resultDiv.textContent += '✓ FCM TOKEN GENERATED!\n';
          resultDiv.textContent += '========================\n';
          resultDiv.textContent += token + '\n';
          resultDiv.textContent += '========================\n';
          
          // Save to clipboard
          navigator.clipboard.writeText(token).then(() => {
            resultDiv.textContent += '✓ Copied to clipboard\n';
          });
          
          console.log('FCM Token:', token);
          
          // Save to Supabase (your existing code)
          if (typeof saveFCMTokenToSupabase === 'function') {
            saveFCMTokenToSupabase(token);
          }
          
        } else {
          resultDiv.textContent += '✗ No token received\n';
        }
        
      } catch (err) {
        console.error('FCM Error:', err);
        resultDiv.textContent += `\n✗ ERROR: ${err.message}\n`;
        
        if (err.code === 'messaging/token-subscribe-failed') {
          resultDiv.textContent += '\n=== ACTION REQUIRED ===\n';
          resultDiv.textContent += '1. Go to: https://console.cloud.google.com/apis/library/firebasecloudmessaging.googleapis.com\n';
          resultDiv.textContent += '2. Select project: gpms-notifications\n';
          resultDiv.textContent += '3. Click ENABLE\n';
          resultDiv.textContent += '4. Wait 2 minutes and try again\n';
        }
      }
    }
  </script>
</body>
</html>
