<!DOCTYPE html>
<html>
<head>
  <title>FCM Test - Manual Push Subscription (Workaround)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #result { 
      background: #f5f5f5; 
      padding: 15px; 
      margin-top: 20px; 
      border-radius: 5px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
    }
    button { 
      padding: 10px 20px; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #45a049; }
    .success { color: green; font-weight: bold; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h2>FCM Manual Push Subscription Test</h2>
  <p>This bypasses Firebase SDK authentication issues and gets the push subscription directly.</p>
  
  <button onclick="testManualPush()">Test Manual Push Subscription</button>
  <button onclick="copyToClipboard()" style="background: #008CBA; margin-left: 10px;">Copy Token to Clipboard</button>
  
  <div id="result"></div>
  
  <script>
    let currentToken = '';
    
    async function testManualPush() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<span class="info">Starting manual push subscription...</span>\n';
      
      try {
        // Step 1: Check service worker support
        if (!('serviceWorker' in navigator)) {
          resultDiv.innerHTML += '<span class="error">✗ Service workers not supported</span>\n';
          return;
        }
        
        // Step 2: Register service worker
        resultDiv.innerHTML += '1. Registering service worker...\n';
        
        const registration = await navigator.serviceWorker.register(
          '/gpms/firebase-messaging-sw.js',
          { scope: '/gpms/' }
        );
        
        resultDiv.innerHTML += '<span class="success">✓ Service worker registered</span>\n';
        console.log('Service worker scope:', registration.scope);
        
        // Wait for service worker to be active
        if (registration.installing) {
          await new Promise(resolve => {
            registration.installing.addEventListener('statechange', (e) => {
              if (e.target.state === 'activated') {
                resolve();
              }
            });
          });
        }
        
        // Step 3: Request notification permission
        resultDiv.innerHTML += '2. Requesting notification permission...\n';
        const permission = await Notification.requestPermission();
        resultDiv.innerHTML += `Permission status: ${permission}\n`;
        
        if (permission !== 'granted') {
          resultDiv.innerHTML += '<span class="error">✗ Notification permission denied</span>\n';
          return;
        }
        
        resultDiv.innerHTML += '<span class="success">✓ Permission granted</span>\n';
        
        // Step 4: Convert VAPID key to Uint8Array
        resultDiv.innerHTML += '3. Converting VAPID key...\n';
        
        const vapidKey = 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq';
        
        function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }
        
        const applicationServerKey = urlBase64ToUint8Array(vapidKey);
        resultDiv.innerHTML += '<span class="success">✓ VAPID key converted</span>\n';
        
        // Step 5: Subscribe to push notifications
        resultDiv.innerHTML += '4. Subscribing to push notifications...\n';
        
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        });
        
        resultDiv.innerHTML += '<span class="success">✓ Push subscription successful!</span>\n';
        
        // Step 6: Convert subscription to JSON
        const subscriptionJSON = subscription.toJSON();
        
        // Extract FCM token from endpoint
        // Format: https://fcm.googleapis.com/fcm/send/{FCM_TOKEN}
        const endpoint = subscriptionJSON.endpoint;
        const fcmToken = endpoint.split('/').pop();
        
        currentToken = fcmToken;
        
        // Display results
        resultDiv.innerHTML += '\n=== SUBSCRIPTION DETAILS ===\n';
        resultDiv.innerHTML += `Endpoint: ${endpoint}\n`;
        resultDiv.innerHTML += `FCM Token: ${fcmToken}\n`;
        
        if (subscriptionJSON.keys) {
          resultDiv.innerHTML += `Auth: ${subscriptionJSON.keys.auth}\n`;
          resultDiv.innerHTML += `P256dh: ${subscriptionJSON.keys.p256dh}\n`;
        }
        
        resultDiv.innerHTML += '\n<span class="success">✅ MANUAL PUSH SUBSCRIPTION COMPLETE!</span>\n';
        resultDiv.innerHTML += 'You can now use this FCM token with any push service.\n';
        
        // Save to localStorage for testing
        localStorage.setItem('fcm_push_subscription', JSON.stringify(subscriptionJSON));
        console.log('Subscription saved to localStorage');
        
        // Step 7: Test sending a notification (optional)
        resultDiv.innerHTML += '\n5. Testing notification...\n';
        await testNotification(fcmToken);
        
      } catch (err) {
        console.error('Manual push error:', err);
        resultDiv.innerHTML += `<span class="error">✗ Error: ${err.message}</span>\n`;
        
        if (err.name === 'NotAllowedError') {
          resultDiv.innerHTML += '<span class="error">Notification permission was denied</span>\n';
        } else if (err.name === 'InvalidStateError') {
          resultDiv.innerHTML += '<span class="error">Already subscribed to push notifications</span>\n';
        }
      }
    }
    
    async function testNotification(fcmToken) {
      const resultDiv = document.getElementById('result');
      
      try {
        // This would normally be done server-side
        // For testing, we'll just show what the server would send
        resultDiv.innerHTML += 'To send a test notification, use this curl command:\n\n';
        resultDiv.innerHTML += `curl -X POST \\
  -H "Authorization: key=AIzaSyBNpWwlJV-2ay7_D8_AXfM2k_WpImVIEYs" \\
  -H "Content-Type: application/json" \\
  -d '{
    "to": "${fcmToken}",
    "notification": {
      "title": "Test Notification",
      "body": "This is a test from GPMS",
      "icon": "/gpms/Picture1.png"
    }
  }' \\
  https://fcm.googleapis.com/fcm/send\n\n`;
        
        resultDiv.innerHTML += '<span class="success">✓ Test command generated</span>\n';
        
      } catch (err) {
        resultDiv.innerHTML += `<span class="error">Notification test error: ${err.message}</span>\n`;
      }
    }
    
    function copyToClipboard() {
      if (!currentToken) {
        alert('No token available. Run the test first.');
        return;
      }
      
      navigator.clipboard.writeText(currentToken).then(() => {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML += '\n<span class="success">✓ Token copied to clipboard!</span>\n';
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed: ' + err.message);
      });
    }
    
    // Check existing subscription on page load
    window.addEventListener('load', async () => {
      const resultDiv = document.getElementById('result');
      
      try {
        if ('serviceWorker' in navigator) {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          
          if (subscription) {
            const subJSON = subscription.toJSON();
            const fcmToken = subJSON.endpoint.split('/').pop();
            currentToken = fcmToken;
            
            resultDiv.innerHTML = `<span class="info">Already subscribed to push notifications</span>\n`;
            resultDiv.innerHTML += `FCM Token: ${fcmToken}\n\n`;
            resultDiv.innerHTML += 'Click "Test Manual Push Subscription" to get a new token.\n';
          } else {
            resultDiv.innerHTML = '<span class="info">Not subscribed to push notifications yet.</span>\n';
            resultDiv.innerHTML += 'Click "Test Manual Push Subscription" to get started.\n';
          }
        }
      } catch (err) {
        console.log('No existing subscription:', err.message);
      }
    });
    
    // Also test with Firebase SDK to compare
    async function testWithFirebaseSDK() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = 'Testing with Firebase SDK...\n';
      
      try {
        // Load Firebase SDK dynamically
        if (typeof firebase === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js';
          document.head.appendChild(script);
          
          await new Promise(resolve => {
            script.onload = resolve;
          });
          
          const script2 = document.createElement('script');
          script2.src = 'https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js';
          document.head.appendChild(script2);
          
          await new Promise(resolve => {
            script2.onload = resolve;
          });
        }
        
        const firebaseConfig = {
          apiKey: "AIzaSyBNpWwlJV-2ay7_D8_AXfM2k_WpImVIEYs",
          authDomain: "gpms-notifications.firebaseapp.com",
          projectId: "gpms-notifications",
          storageBucket: "gpms-notifications.firebasestorage.app",
          messagingSenderId: "240580625031",
          appId: "1:240580625031:web:52421c30f5f542dfd0ae22",
          measurementId: "G-D41F7DQVLP"
        };
        
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();
        
        resultDiv.innerHTML += 'Firebase SDK initialized\n';
        
      } catch (err) {
        resultDiv.innerHTML += `<span class="error">Firebase SDK test error: ${err.message}</span>\n`;
      }
    }
  </script>
  
  <!-- Optional: Include this to test Firebase SDK side-by-side -->
  <!-- 
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js"></script>
  -->
</body>
</html>
