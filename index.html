<!DOCTYPE html>
<html>
<head>
  <title>FCM Test - Browser Detection</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #result { 
      background: #f5f5f5; 
      padding: 15px; 
      margin-top: 20px; 
      border-radius: 5px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
    }
    button { 
      padding: 10px 20px; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #45a049; }
    .success { color: green; font-weight: bold; }
    .error { color: red; }
    .info { color: blue; }
    .warning { color: orange; }
  </style>
</head>
<body>
  <h2>Push Notification Test - Multi-Browser Support</h2>
  
  <div id="browser-info" style="margin-bottom: 20px; padding: 10px; background: #e3f2fd; border-radius: 4px;"></div>
  
  <button onclick="testPushSubscription()">Test Push Subscription</button>
  <button onclick="detectBrowser()" style="background: #ff9800; margin-left: 10px;">Detect Browser</button>
  
  <div id="result"></div>
  
  <script>
    function detectBrowser() {
      const browserInfo = document.getElementById('browser-info');
      const userAgent = navigator.userAgent;
      let browser = 'Unknown';
      let pushService = 'Unknown';
      
      if (userAgent.includes('Edg')) {
        browser = 'Microsoft Edge';
        pushService = 'WNS (Windows Notification Service)';
      } else if (userAgent.includes('Chrome')) {
        browser = 'Google Chrome';
        pushService = 'FCM (Firebase Cloud Messaging)';
      } else if (userAgent.includes('Firefox')) {
        browser = 'Mozilla Firefox';
        pushService = 'Firefox Push Service';
      } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
        browser = 'Apple Safari';
        pushService = 'APNs (Apple Push Notification Service)';
      }
      
      browserInfo.innerHTML = `
        <strong>Browser:</strong> ${browser}<br>
        <strong>Push Service:</strong> ${pushService}<br>
        <strong>User Agent:</strong> ${userAgent}
      `;
      
      console.log('Browser:', browser);
      console.log('Push Service:', pushService);
      
      return { browser, pushService };
    }
    
    async function testPushSubscription() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      
      const { browser, pushService } = detectBrowser();
      
      resultDiv.innerHTML += `<span class="info">Detected: ${browser} (${pushService})</span>\n\n`;
      
      try {
        // Step 1: Register service worker
        resultDiv.innerHTML += '1. Registering service worker...\n';
        
        const registration = await navigator.serviceWorker.register(
          '/gpms/firebase-messaging-sw.js',
          { scope: '/gpms/' }
        );
        
        resultDiv.innerHTML += '<span class="success">✓ Service worker registered</span>\n';
        
        // Step 2: Request permission
        resultDiv.innerHTML += '2. Requesting notification permission...\n';
        const permission = await Notification.requestPermission();
        resultDiv.innerHTML += `Permission: ${permission}\n`;
        
        if (permission !== 'granted') {
          resultDiv.innerHTML += '<span class="error">✗ Permission denied</span>\n';
          return;
        }
        
        resultDiv.innerHTML += '<span class="success">✓ Permission granted</span>\n';
        
        // Step 3: Get existing subscription
        resultDiv.innerHTML += '3. Checking existing subscription...\n';
        let subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          resultDiv.innerHTML += '<span class="info">✓ Already subscribed</span>\n';
        } else {
          // Step 4: Create new subscription
          resultDiv.innerHTML += '4. Creating new subscription...\n';
          
          const vapidKey = 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq';
          const applicationServerKey = urlBase64ToUint8Array(vapidKey);
          
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: applicationServerKey
          });
          
          resultDiv.innerHTML += '<span class="success">✓ Push subscription created</span>\n';
        }
        
        // Step 5: Analyze subscription
        const subscriptionJSON = subscription.toJSON();
        resultDiv.innerHTML += '\n=== SUBSCRIPTION ANALYSIS ===\n';
        
        resultDiv.innerHTML += `Endpoint: ${subscriptionJSON.endpoint}\n`;
        
        // Check endpoint type
        if (subscriptionJSON.endpoint.includes('fcm.googleapis.com')) {
          resultDiv.innerHTML += '<span class="success">✅ FCM ENDPOINT DETECTED</span>\n';
          const fcmToken = subscriptionJSON.endpoint.split('/').pop();
          resultDiv.innerHTML += `FCM Token: ${fcmToken}\n`;
          
          // Test FCM notification
          await testFCMNotification(fcmToken, resultDiv);
          
        } else if (subscriptionJSON.endpoint.includes('wns2-')) {
          resultDiv.innerHTML += '<span class="warning">⚠️ WNS ENDPOINT DETECTED (Microsoft Edge)</span>\n';
          resultDiv.innerHTML += 'To send notifications via WNS, you need:\n';
          resultDiv.innerHTML += '1. Windows developer account\n';
          resultDiv.innerHTML += '2. WNS credentials from Microsoft\n';
          resultDiv.innerHTML += '3. Server-side WNS integration\n';
          
        } else if (subscriptionJSON.endpoint.includes('updates.push.services.mozilla.com')) {
          resultDiv.innerHTML += '<span class="info">ℹ️ FIREFOX PUSH ENDPOINT DETECTED</span>\n';
          
        } else {
          resultDiv.innerHTML += `<span class="info">ℹ️ UNKNOWN ENDPOINT TYPE: ${subscriptionJSON.endpoint}</span>\n`;
        }
        
        // Save subscription data
        localStorage.setItem('push_subscription', JSON.stringify(subscriptionJSON));
        
      } catch (err) {
        console.error('Error:', err);
        resultDiv.innerHTML += `<span class="error">✗ Error: ${err.message}</span>\n`;
      }
    }
    
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    
    async function testFCMNotification(fcmToken, resultDiv) {
      resultDiv.innerHTML += '\n=== FCM TEST ===\n';
      
      // For security reasons, we can't send actual notifications from browser
      // This would be done server-side
      resultDiv.innerHTML += 'Server-side code to send notification:\n\n';
      
      resultDiv.innerHTML += `// Node.js example
const admin = require('firebase-admin');

admin.initializeApp({
  credential: admin.credential.applicationDefault(),
  projectId: 'gpms-notifications'
});

const message = {
  token: '${fcmToken}',
  notification: {
    title: 'Test from GPMS',
    body: 'This is a test notification'
  }
};

admin.messaging().send(message)
  .then(response => {
    console.log('Success:', response);
  })
  .catch(error => {
    console.error('Error:', error);
  });\n\n`;
      
      resultDiv.innerHTML += '<span class="success">✓ FCM integration code generated</span>\n';
    }
    
    // Auto-detect on page load
    window.addEventListener('load', () => {
      detectBrowser();
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<span class="info">Page loaded. Click "Test Push Subscription" to begin.</span>\n';
      resultDiv.innerHTML += '<span class="warning">Note: For FCM tokens, use Chrome or Firefox browser.</span>\n';
    });
  </script>
</body>
</html>
