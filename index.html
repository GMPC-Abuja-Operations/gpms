<!DOCTYPE html>
<html>
<head>
  <title>Multi-Browser Push Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .banner { 
      background: #e3f2fd; 
      padding: 15px; 
      border-radius: 5px; 
      margin-bottom: 20px;
      border-left: 4px solid #2196f3;
    }
    .chrome-banner { background: #e8f5e8; border-left-color: #4caf50; }
    .edge-banner { background: #f3e5f5; border-left-color: #9c27b0; }
    button { 
      padding: 12px 24px; 
      background: #2196f3; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    .chrome-btn { background: #4caf50; }
    .edge-btn { background: #9c27b0; }
    #result { 
      background: #f5f5f5; 
      padding: 20px; 
      margin-top: 20px; 
      border-radius: 5px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid #ddd;
    }
    .success { color: #4caf50; font-weight: bold; }
    .warning { color: #ff9800; font-weight: bold; }
    .error { color: #f44336; }
    .info { color: #2196f3; }
  </style>
</head>
<body>
  <h1>Push Notification Compatibility Test</h1>
  
  <div id="browser-banner" class="banner">
    <strong id="browser-name">Detecting browser...</strong><br>
    <span id="push-service">Checking push service...</span>
  </div>
  
  <div style="margin: 20px 0;">
    <h3>Test Options:</h3>
    <button onclick="testInChrome()" class="chrome-btn">Test in Chrome (Recommended for FCM)</button>
    <button onclick="testCurrentBrowser()">Test in Current Browser</button>
    <button onclick="clearSubscription()" style="background: #ff9800;">Clear Subscription</button>
  </div>
  
  <div id="chrome-instructions" class="banner chrome-banner" style="display: none;">
    <h3>üöÄ For Firebase Cloud Messaging (FCM):</h3>
    <p>Use <strong>Google Chrome</strong> for proper FCM support:</p>
    <ol>
      <li>Open this page in <strong>Google Chrome</strong></li>
      <li>Click "Test in Current Browser"</li>
      <li>You'll get a proper FCM token for Firebase</li>
    </ol>
  </div>
  
  <div id="edge-instructions" class="banner edge-banner" style="display: none;">
    <h3>‚ÑπÔ∏è Microsoft Edge Information:</h3>
    <p>Edge uses Windows Notification Service (WNS), not Firebase Cloud Messaging.</p>
    <p><strong>To use Firebase with Edge:</strong></p>
    <ol>
      <li>Users must install your app as a PWA</li>
      <li>Use Firebase SDK's <code>getToken()</code> method</li>
      <li>Firebase will handle WNS internally</li>
    </ol>
  </div>
  
  <div id="result"></div>
  
  <script>
    // Detect browser on load
    function detectBrowserAndService() {
      const userAgent = navigator.userAgent;
      let browser = 'Unknown';
      let pushService = 'Unknown';
      let isChrome = false;
      let isEdge = false;
      let isFirefox = false;
      let isSafari = false;
      
      if (userAgent.includes('Edg')) {
        browser = 'Microsoft Edge';
        pushService = 'WNS (Windows Notification Service)';
        isEdge = true;
      } else if (userAgent.includes('Chrome')) {
        browser = 'Google Chrome';
        pushService = 'FCM (Firebase Cloud Messaging)';
        isChrome = true;
      } else if (userAgent.includes('Firefox')) {
        browser = 'Mozilla Firefox';
        pushService = 'Firefox Push Service';
        isFirefox = true;
      } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
        browser = 'Apple Safari';
        pushService = 'APNs (Apple Push Notification Service)';
        isSafari = true;
      }
      
      const banner = document.getElementById('browser-banner');
      const browserName = document.getElementById('browser-name');
      const pushServiceSpan = document.getElementById('push-service');
      
      browserName.textContent = `Browser: ${browser}`;
      pushServiceSpan.textContent = `Push Service: ${pushService}`;
      
      // Show appropriate instructions
      if (isChrome) {
        document.getElementById('chrome-instructions').style.display = 'block';
        banner.className = 'banner chrome-banner';
      } else if (isEdge) {
        document.getElementById('edge-instructions').style.display = 'block';
        banner.className = 'banner edge-banner';
      }
      
      return { browser, pushService, isChrome, isEdge, isFirefox, isSafari };
    }
    
    async function testCurrentBrowser() {
      const resultDiv = document.getElementById('result');
      const detection = detectBrowserAndService();
      
      resultDiv.innerHTML = `<span class="info">Testing in ${detection.browser}...</span>\n\n`;
      
      try {
        // Step 1: Service Worker
        resultDiv.innerHTML += '1. Setting up service worker...\n';
        const registration = await navigator.serviceWorker.register(
          '/gpms/firebase-messaging-sw.js',
          { scope: '/gpms/' }
        );
        resultDiv.innerHTML += '<span class="success">‚úì Service worker ready</span>\n';
        
        // Step 2: Permission
        resultDiv.innerHTML += '2. Checking notification permission...\n';
        const permission = await Notification.requestPermission();
        resultDiv.innerHTML += `Permission: ${permission}\n`;
        
        if (permission !== 'granted') {
          resultDiv.innerHTML += '<span class="error">‚úó Permission denied</span>\n';
          return;
        }
        resultDiv.innerHTML += '<span class="success">‚úì Permission granted</span>\n';
        
        // Step 3: Try Firebase SDK if available
        if (typeof firebase !== 'undefined' && detection.isChrome) {
          resultDiv.innerHTML += '3. Trying Firebase SDK (Chrome only)...\n';
          try {
            const messaging = firebase.messaging();
            const token = await messaging.getToken({
              vapidKey: 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq',
              serviceWorkerRegistration: registration
            });
            
            if (token) {
              resultDiv.innerHTML += '<span class="success">‚úÖ FCM TOKEN VIA FIREBASE SDK:</span>\n';
              resultDiv.innerHTML += `${token}\n\n`;
              saveToken(token, 'firebase_sdk');
              return;
            }
          } catch (firebaseError) {
            resultDiv.innerHTML += `<span class="warning">Firebase SDK error: ${firebaseError.message}</span>\n`;
          }
        }
        
        // Step 4: Manual subscription
        resultDiv.innerHTML += '4. Creating manual push subscription...\n';
        
        const vapidKey = 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq';
        const applicationServerKey = urlBase64ToUint8Array(vapidKey);
        
        let subscription = await registration.pushManager.getSubscription();
        if (!subscription) {
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: applicationServerKey
          });
        }
        
        const subscriptionJSON = subscription.toJSON();
        resultDiv.innerHTML += '<span class="success">‚úì Push subscription obtained</span>\n\n';
        
        // Analyze endpoint
        resultDiv.innerHTML += '=== ENDPOINT ANALYSIS ===\n';
        resultDiv.innerHTML += `URL: ${subscriptionJSON.endpoint}\n`;
        
        if (subscriptionJSON.endpoint.includes('fcm.googleapis.com')) {
          const fcmToken = subscriptionJSON.endpoint.split('/').pop();
          resultDiv.innerHTML += '<span class="success">‚úÖ FCM ENDPOINT DETECTED</span>\n';
          resultDiv.innerHTML += `FCM Token: ${fcmToken}\n`;
          saveToken(fcmToken, 'manual_fcm');
          
        } else if (subscriptionJSON.endpoint.includes('wns2-')) {
          resultDiv.innerHTML += '<span class="warning">‚ö†Ô∏è WNS ENDPOINT (Microsoft Edge)</span>\n';
          resultDiv.innerHTML += 'Edge uses Windows Notification Service.\n';
          resultDiv.innerHTML += 'For Firebase support in Edge:\n';
          resultDiv.innerHTML += '1. Install as PWA\n';
          resultDiv.innerHTML += '2. Use Firebase SDK getToken()\n';
          
        } else {
          resultDiv.innerHTML += `<span class="info">‚ÑπÔ∏è Browser-native push endpoint</span>\n`;
          resultDiv.innerHTML += `Auth: ${subscriptionJSON.keys?.auth || 'N/A'}\n`;
          resultDiv.innerHTML += `p256dh: ${subscriptionJSON.keys?.p256dh || 'N/A'}\n`;
        }
        
      } catch (err) {
        console.error('Test error:', err);
        resultDiv.innerHTML += `<span class="error">‚úó Error: ${err.message}</span>\n`;
      }
    }
    
    function testInChrome() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<span class="info">For FCM testing:</span>\n\n';
      resultDiv.innerHTML += '1. Open <strong>Google Chrome</strong>\n';
      resultDiv.innerHTML += '2. Navigate to this same URL\n';
      resultDiv.innerHTML += '3. Click "Test in Current Browser"\n';
      resultDiv.innerHTML += '\n<span class="success">Chrome will give you proper FCM tokens that work with Firebase.</span>\n';
    }
    
    async function clearSubscription() {
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          await subscription.unsubscribe();
          console.log('Subscription cleared');
          alert('Push subscription cleared successfully!');
        } else {
          alert('No active subscription found.');
        }
      } catch (err) {
        console.error('Clear error:', err);
        alert('Error clearing subscription: ' + err.message);
      }
    }
    
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    
    function saveToken(token, source) {
      // Save to localStorage for testing
      localStorage.setItem('last_fcm_token', token);
      localStorage.setItem('token_source', source);
      localStorage.setItem('token_timestamp', new Date().toISOString());
      
      // Copy to clipboard
      navigator.clipboard.writeText(token).then(() => {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML += '\n<span class="success">‚úì Token copied to clipboard!</span>\n';
      });
    }
    
    // Initialize
    window.addEventListener('load', () => {
      detectBrowserAndService();
      
      // Check for existing token
      const lastToken = localStorage.getItem('last_fcm_token');
      if (lastToken) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `<span class="info">Last saved token:</span>\n`;
        resultDiv.innerHTML += `${lastToken}\n\n`;
        resultDiv.innerHTML += `<span class="info">Source: ${localStorage.getItem('token_source')}</span>\n`;
        resultDiv.innerHTML += `<span class="info">Time: ${new Date(localStorage.getItem('token_timestamp')).toLocaleString()}</span>\n`;
      }
    });
  </script>
  
  <!-- Load Firebase only for Chrome testing -->
  <script>
    // Only load Firebase if in Chrome (for FCM testing)
    const userAgent = navigator.userAgent;
    if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
      const firebaseScript = document.createElement('script');
      firebaseScript.src = 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js';
      document.head.appendChild(firebaseScript);
      
      firebaseScript.onload = () => {
        const messagingScript = document.createElement('script');
        messagingScript.src = 'https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js';
        document.head.appendChild(messagingScript);
        
        messagingScript.onload = () => {
          // Initialize Firebase
          const firebaseConfig = {
            apiKey: "AIzaSyBNpWwlJV-2ay7_D8_AXfM2k_WpImVIEYs",
            authDomain: "gpms-notifications.firebaseapp.com",
            projectId: "gpms-notifications",
            storageBucket: "gpms-notifications.firebasestorage.app",
            messagingSenderId: "240580625031",
            appId: "1:240580625031:web:52421c30f5f542dfd0ae22",
            measurementId: "G-D41F7DQVLP"
          };
          
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase loaded for Chrome FCM testing');
          }
        };
      };
    }
  </script>
</body>
</html>
