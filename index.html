<!DOCTYPE html>
<html>
<head>
  <title>FCM Test - Fixed Service Worker Path</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js"></script>
</head>
<body>
  <h2>FCM Test - With Correct Service Worker Path</h2>
  <button onclick="testFCM()">Test Firebase Messaging</button>
  <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBNpWwlJV-2ay7_D8_AXfM2k_WpImVIEYs",
      authDomain: "gpms-notifications.firebaseapp.com",
      projectId: "gpms-notifications",
      storageBucket: "gpms-notifications.firebasestorage.app",
      messagingSenderId: "240580625031",
      appId: "1:240580625031:web:52421c30f5f542dfd0ae22",
      measurementId: "G-D41F7DQVLP"
    };
    
    console.log('Firebase v10.14.1 - Config:', firebaseConfig);
    
    // Initialize Firebase
    try {
      if (firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase initialized');
      }
    } catch (err) {
      console.error('Firebase init error:', err);
    }
    
    async function testFCM() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = 'Testing FCM with service worker...';
      
      try {
        // Step 1: Check service worker support
        if (!('serviceWorker' in navigator)) {
          throw new Error('Service workers not supported');
        }
        
        // Step 2: Register service worker at correct path
        resultDiv.innerHTML += '<br>1. Registering service worker...';
        const registration = await navigator.serviceWorker.register(
          '/gpms/firebase-messaging-sw.js',
          {
            scope: '/gpms/'
          }
        );
        
        console.log('Service worker registered:', registration);
        resultDiv.innerHTML += '<br>✓ Service worker registered at: ' + registration.scope;
        
        // Wait for service worker to be ready
        if (registration.waiting) {
          resultDiv.innerHTML += '<br>Service worker is waiting';
        }
        if (registration.active) {
          resultDiv.innerHTML += '<br>✓ Service worker is active';
        }
        
        // Step 3: Request notification permission
        resultDiv.innerHTML += '<br>2. Requesting notification permission...';
        const permission = await Notification.requestPermission();
        resultDiv.innerHTML += '<br>Permission: ' + permission;
        
        if (permission !== 'granted') {
          resultDiv.innerHTML += '<br><span style="color: orange;">Permission denied</span>';
          return;
        }
        
        // Step 4: Get messaging instance
        const messaging = firebase.messaging();
        
        // Step 5: Get FCM token with service worker registration
        resultDiv.innerHTML += '<br>3. Getting FCM token...';
        const token = await messaging.getToken({
          vapidKey: 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq',
          serviceWorkerRegistration: registration
        });
        
        console.log('Token received:', token);
        
        if (token) {
          resultDiv.innerHTML += '<br><span style="color: green; font-weight: bold;">✓ SUCCESS! FCM Token generated</span>';
          resultDiv.innerHTML += `<br><small style="word-break: break-all; background: #f5f5f5; padding: 5px; display: block;">${token}</small>`;
        } else {
          resultDiv.innerHTML += '<br><span style="color: red;">✗ No token generated</span>';
        }
        
      } catch (err) {
        console.error('Error:', err);
        resultDiv.innerHTML = `<span style="color: red;">ERROR: ${err.message}</span>`;
        
        if (err.message.includes('404')) {
          resultDiv.innerHTML += '<br><br><strong>Service worker file not found!</strong>';
          resultDiv.innerHTML += '<br>Make sure firebase-messaging-sw.js exists at:';
          resultDiv.innerHTML += '<br><code>/gpms/firebase-messaging-sw.js</code>';
          resultDiv.innerHTML += '<br><br>Current URL: ' + window.location.href;
        }
      }
    }
    
    // Quick check: verify service worker file exists
    window.addEventListener('load', async () => {
      try {
        const response = await fetch('/gpms/firebase-messaging-sw.js');
        console.log('Service worker file exists:', response.ok);
        
        if (!response.ok) {
          console.error('Service worker file not found! Status:', response.status);
          document.getElementById('result').innerHTML = 
            '<span style="color: red;">ERROR: Service worker file not found at /gpms/firebase-messaging-sw.js</span>';
        }
      } catch (err) {
        console.error('Cannot fetch service worker:', err);
      }
    });
  </script>
</body>
</html>
