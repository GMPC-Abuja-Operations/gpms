<!DOCTYPE html>
<html>
<head>
  <title>Multi-Browser FCM Test</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .card { 
      background: white; 
      padding: 20px; 
      margin: 20px 0; 
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button { 
      padding: 12px 24px; 
      background: #D4AF37; 
      color: #4A2C2A; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin: 10px 5px;
    }
    button:hover { background: #B8972E; }
    .chrome { background: #4CAF50; color: white; }
    .edge { background: #9C27B0; color: white; }
    #result { 
      background: #F5F0E1; 
      padding: 20px; 
      margin-top: 20px; 
      border-radius: 6px;
      border: 1px solid #D4AF37;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .info { color: #2196f3; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Multi-Browser FCM Test</h2>
    <p>Test FCM/push notifications in different browsers.</p>
    
    <div id="browser-info" style="margin: 15px 0; padding: 10px; background: #e3f2fd; border-radius: 4px;"></div>
    
    <button onclick="testChromeMethod()" class="chrome">Test Chrome Method</button>
    <button onclick="testEdgeMethod()" class="edge">Test Edge Method</button>
    <button onclick="testUniversalMethod()">Test Universal Method</button>
    
    <div id="result"></div>
  </div>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBNpWwlJV-2ay7_D8_AXfM2k_WpImVIEYs",
      authDomain: "gpms-notifications.firebaseapp.com",
      projectId: "gpms-notifications",
      storageBucket: "gpms-notifications.firebasestorage.app",
      messagingSenderId: "240580625031",
      appId: "1:240580625031:web:52421c30f5f542dfd0ae22",
      measurementId: "G-D41F7DQVLP"
    };
    
    // Supabase config
    const SUPABASE_URL = 'https://sudsanzsdppdjcsvsukf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1ZHNhbnpzZHBwZGpjc3ZzdWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzM5NTIsImV4cCI6MjA4NTUwOTk1Mn0.tReoBHtVOyB4OWV5W-jPpt1xvpRlUKKQSXBOFdMXzAo';
    
    let supabase;
    let currentUser = { id: 'test-user' }; // Mock user for testing
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Detect browser
      const userAgent = navigator.userAgent;
      const isEdge = userAgent.includes('Edg');
      const isChrome = userAgent.includes('Chrome') && !isEdge;
      
      const browserInfo = document.getElementById('browser-info');
      if (isChrome) {
        browserInfo.innerHTML = '<strong>Browser:</strong> Google Chrome (FCM compatible)';
        browserInfo.style.background = '#e8f5e8';
      } else if (isEdge) {
        browserInfo.innerHTML = '<strong>Browser:</strong> Microsoft Edge (WNS via Firebase)';
        browserInfo.style.background = '#f3e5f5';
      }
      
      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      
      // Initialize Supabase (mock for testing)
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    });
    
    async function testChromeMethod() {
      const result = document.getElementById('result');
      result.innerHTML = '<span class="info">Testing Chrome method...</span>\n';
      
      try {
        const token = await getManualFCMToken();
        result.innerHTML += `<span class="success">✅ Chrome FCM Token:</span>\n${token}\n`;
        
        // Simulate saving to Supabase
        localStorage.setItem('fcm_token', token);
        
      } catch (err) {
        result.innerHTML += `<span class="error">❌ Error: ${err.message}</span>\n`;
      }
    }
    
    async function testEdgeMethod() {
      const result = document.getElementById('result');
      result.innerHTML = '<span class="info">Testing Edge method...</span>\n';
      
      try {
        // Edge should use Firebase SDK
        const messaging = firebase.messaging();
        
        // Register service worker
        const registration = await navigator.serviceWorker.register(
          '/gpms/firebase-messaging-sw.js',
          { scope: '/gpms/' }
        );
        
        // Get permission
        await Notification.requestPermission();
        
        // Get token via Firebase SDK
        const token = await messaging.getToken({
          vapidKey: 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq',
          serviceWorkerRegistration: registration
        });
        
        result.innerHTML += `<span class="success">✅ Edge Token (via Firebase SDK):</span>\n${token}\n`;
        
      } catch (err) {
        result.innerHTML += `<span class="error">❌ Firebase SDK Error: ${err.message}</span>\n`;
        result.innerHTML += '<span class="info">Trying manual method as fallback...</span>\n';
        
        // Fallback to manual method
        try {
          const manualToken = await getManualFCMToken();
          result.innerHTML += `<span class="success">✅ Fallback Token:</span>\n${manualToken}\n`;
        } catch (manualErr) {
          result.innerHTML += `<span class="error">❌ Manual method also failed: ${manualErr.message}</span>\n`;
        }
      }
    }
    
    async function testUniversalMethod() {
      const result = document.getElementById('result');
      result.innerHTML = '<span class="info">Testing universal method (works in all browsers)...</span>\n';
      
      try {
        const token = await getManualFCMToken();
        result.innerHTML += `<span class="success">✅ Universal Token:</span>\n${token}\n`;
        
        // Analyze token type
        if (token.includes('fcm.googleapis.com')) {
          result.innerHTML += '<span class="success">Token Type: FCM (Chrome/Firefox)</span>\n';
        } else if (token.includes('wns2-')) {
          result.innerHTML += '<span class="info">Token Type: WNS (Microsoft Edge)</span>\n';
        }
        
      } catch (err) {
        result.innerHTML += `<span class="error">❌ Error: ${err.message}</span>\n`;
      }
    }
    
    async function getManualFCMToken() {
      // Register service worker
      const registration = await navigator.serviceWorker.register(
        '/gpms/firebase-messaging-sw.js',
        { scope: '/gpms/' }
      );
      
      // Request permission
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        throw new Error('Notification permission denied');
      }
      
      // Create subscription
      const vapidKey = 'BKdTc_pfiAr5rsfkNcPxnulEeIt7dTHi_TxX61RYNC2g0zZ4-0WzJpU-PvdqW14WuOIZf_KDeD45gg2Ri6Eoxbq';
      const applicationServerKey = urlBase64ToUint8Array(vapidKey);
      
      let subscription = await registration.pushManager.getSubscription();
      if (!subscription) {
        subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        });
      }
      
      const subscriptionJSON = subscription.toJSON();
      return subscriptionJSON.endpoint;
    }
    
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
  </script>
</body>
</html>
